---
layout:     post
title:      linux代理
subtitle:    代理
date:       2019-6-10
author:     XT
header-img: img/post-bg-coffee.jpeg
catalog: 	 true
tags:
    - web
    - 代理
---


> 代理原理

## 正向代理

> 一般情况下，如果没有特别说明，代理技术默认说的是正向代理技术。关于正向代理的概念如下：

![](https://raw.githubusercontent.com/xineting/xineting.github.io/master/pic/1.png)

### 正向代理(forward)概念

> 是一个位于客户端【用户A】和原始服务器(origin server)【服务器B】之间的服务器【代理服务器Z】
> 为了从原始服务器取得内容，用户A向代理服务器Z发送一个请求并指定目标(服务器B)
> 然后代理服务器Z向服务器B转交请求并将获得的内容返回给客户端。



### 正向代理的作用

* 访问本无法访问的服务器B

![img](https://raw.githubusercontent.com/xineting/xineting.github.io/master/pic/2.png)

* 加速访问服务器B

* Cache作用

  * 如果在用户A访问服务器B某数据J之前，已经有人通过代理服务器Z访问过服务器B上得数据J
  * 那么代理服务器Z会把数据J保存一段时间
  * 如果有人正好取该数据J，那么代理服务器Z不再访问服务器B，而把缓存的数据J直接发给用户A，这一技术在Cache中术语就叫Cache命中。
  * 如果有更多的像用户A的用户来访问代理服务器Z，那么这些用户都可以直接从代理服务器Z中取得数据J，而不用千里迢迢的去服务器B下载数据了。

* 客户端访问授权

  ![img](https://raw.githubusercontent.com/xineting/xineting.github.io/master/pic/3.png)

  这方面的内容现今使用的还是比较多的，例如一些公司采用ISA SERVER做为正向代理服务器来授权用户是否有权限访问互联网

  防火墙作为网关，用来过滤外网对其的访问。假设用户A和用户B都设置了代理服务器，用户A允许访问互联网，而用户B不允许访问互联网（这个在代理服务器Z上做限制）这样用户A因为授权，可以通过代理服务器访问到服务器B，而用户B因为没有被代理服务器Z授权，所以访问服务器B时，数据包会被直接丢弃。

  

* 隐藏访问者的行踪

  ![img](https://raw.githubusercontent.com/xineting/xineting.github.io/master/pic/4.png)

  我们可以看出服务器B并不知道访问自己的实际是用户A，因为代理服务器Z代替用户A去直接与服务器B进行交互。如果代理服务器Z被用户A完全控制（或不完全控制），会惯以“肉鸡”术语称呼。

### 正向总结

简单来说，正向代理就是一个位于客户端和原始服务器(origin server)之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标(原始服务器)，然后代理向原始服务器转交请求并将获得的内容返回给客户端。

客户端必须设置正向代理服务器，当然前提是要知道正向代理服务器的IP地址，还有代理程序的端口。

  

## 反向代理

> 反向代理正好与正向代理相反，对于客户端而言代理服务器就像是原始服务器，并且客户端不需要进行任何特别的设置。客户端向反向代理的命名空间(name-space)中的内容发送普通请求，接着反向代理将判断向何处(原始服务器)转交请求，并将获得的内容返回给客户端。

### 反向代理的作用

* 保护和隐藏原始资源服务器

  用户 A 始终认为它访问的是原始服务器 B 而不是代理服务器 Z 

  但实用际上反向代理服务器接受用户 A 的应答，从原始资源服务器 B 中取得用户 A 的需求资源，然后发送给用户 A 。

  由于防火墙的作用，只允许代理服务器 Z 访问原始资源服务器 B 。

  尽管在这个虚拟的环境下，防火墙和反向代理的共同作用保护了原始资源服务器 B ，但用户 A 并不知情。

![img](https://raw.githubusercontent.com/xineting/xineting.github.io/master/pic/6.png)

* 负载均衡

  当反向代理服务器不止一个的时候，我们甚至可以把它们做成集群

  当更多的用户访问资源服务器B的时候，让不同的代理服务器Z（x）去应答不同的用户，然后发送不同用户需要的资源。
  当然反向代理服务器像正向代理服务器一样拥有CACHE的作用，它可以缓存原始资源服务器B的资源，而不是每次都要向原始资源服务器B请求数据，特别是一些静态的数据，比如图片和文件

  如果这些反向代理服务器能够做到和用户X来自同一个网络，那么用户X访问反向代理服务器X，就会得到很高质量的速度。这正是CDN技术的核心。

  ![img](https://raw.githubusercontent.com/xineting/xineting.github.io/master/pic/7.png)

### 总结

​	反向代理结论与正向代理正好相反，对于客户端而言它就像是原始服务器，并且客户端不需要进行任何特别的设置。	客户端向反向代理的命名空间(name-space)中的内容发送普通请求，接着反向代理将判断向何处(原始服务器)转交请求，并将获得的内容返回给客户端，就像这些内容原本就是它自己的一样。	
​	基本上，网上做正反向代理的程序很多，能做正向代理的软件大部分也可以做反向代理。
​	开源软件中最流行的就是squid，既可以做正向代理，也有很多人用来做反向代理的前端服务器。另外MS ISA也可以用来在WINDOWS平台下，做正向代理。
​	反向代理中最主要的实践就是WEB服务，近些年来最火的就是Nginx了。
​	网上有人说NGINX不能做正向代理，其实是不对的。NGINX也可以做正向代理，不过用的人比较少了。

## 正向代理与反向代理总结

### 正向代理的概念
正向代理，也就是传说中的代理,它的工作原理就像一个跳板，简单的说，我是一个用户，我访问不了某网站，但是我能访问一个代理服务器，这个代理服务器呢，他能访问那个我不能访问的网站，于是我先连上代理服务器，告诉他我需要那个无法访问网站的内容，代理服务器去取回来，然后返回给我。从网站的角度，只在代理服务器来取内容的时候有一次记录，有时候并不知道是用户的请求，也隐藏了用户的资料，这取决于代理告不告诉网站。
结论就是，正向代理 是一个位于客户端和原始服务器(origin server)之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标(原始服务器)，然后代理向原始服务器转交请求并将获得的内容返回给客户端。客户端必须要进行一些特别的设置才能使用正向代理。

### 反向代理的概念
继续举例: 
例用户访问 http://www.kevin.com/readme，但www.kevin.com上并不存在readme页面，他是偷偷从另外一台服务器上取回来，然后作为自己的内容返回用户，但用户并不知情。这里所提到的 www.kevin.com 这个域名对应的服务器就设置了反向代理功能。
结论就是，反向代理正好相反，对于客户端而言它就像是原始服务器，并且客户端不需要进行任何特别的设置。客户端向反向代理的命名空间(name-space)中的内容发送普通请求，接着反向代理将判断向何处(原始服务器)转交请求，并将获得的内容返回给客户端，就像这些内容原本就是它自己的一样。

### 正向和反向代理的区别
从用途上来讲：
正向代理的典型用途是为在防火墙内的局域网客户端提供访问Internet的途径。正向代理还可以使用缓冲特性减少网络使用率。反向代理的典型用途是将防火墙后面的服务器提供给Internet用户访问。反向代理还可以为后端的多台服务器提供负载平衡，或为后端较慢的服务器提供缓冲服务。另外，反向代理还可以启用高级URL策略和管理技术，从而使处于不同web服务器系统的web页面同时存在于同一个URL空间下。

从安全性来讲：
正向代理允许客户端通过它访问任意网站并且隐藏客户端自身，因此你必须采取安全措施以确保仅为经过授权的客户端提供服务。反向代理对外都是透明的，访问者并不知道自己访问的是一个代理。

## 透明代理

用户A和用户B并不知道行为管理设备充当透明代理行为，当用户A或用户B向服务器A或服务器B提交请求的时候，透明代理设备根据自身策略拦截并修改用户A或B的报文，并作为实际的请求方，向服务器A或B发送请求，当接收信息回传，透明代理再根据自身的设置把允许的报文发回至用户A或B，如上图，如果透明代理设置不允许访问服务器B，那么用户A或者用户B就不会得到服务器B的数据。

![img](https://raw.githubusercontent.com/xineting/xineting.github.io/master/pic/5.png)

